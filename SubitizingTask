<!DOCTYPE html>
<html>
<head>
  <title>Subitizing Task</title>
  <script src="jspsych/dist/jspsych.js"></script>
  <script src="jspsych/dist/plugin-preload.js"></script>
  <script src="jspsych/dist/plugin-survey-text.js"></script>
  <script src="jspsych/dist/plugin-fullscreen.js"></script>
  <script src="jspsych/dist/plugin-call-function.js"></script>
  <script src="jspsych/dist/plugin-html-keyboard-response.js"></script>
  <script src="jspsych/dist/plugin-image-keyboard-response.js"></script>
  <link rel="stylesheet" href="jspsych/dist/jspsych.css">
</head>
<body></body>
<script>
  const jsPsych = initJsPsych({
    on_finish: function() {
      //override_safe_mode: true,
      let code = jsPsych.data.get().values()[0].participant_code || "NA";
      jsPsych.data.get().localSave('csv',`subitizing_${code}.csv`);
    }
  });

  const FIXATION_DURATION = 500;
  const WHITE_SCREEN_DURATION = 0;
  const EXPERIMENTER_KEYS = ['0','1','2','3','4','5','6','7','8','9']; 
  const BREAK_KEYS = ['0','1','2','3','4','5','6','7','8','9'];   
  const CHILD_KEY = [' ']; 

  let training_trials = []
  for (let j = 1; j <= 8; j++) {  
        training_trials.push({
        stimulus: `./Subitizing/${j}_V10.png`, 
        correct_response: `${j}`
    });
  };
  training_trials = jsPsych.randomization.sampleWithoutReplacement(training_trials, 4);

  let trials = [];
  for (let i = 1; i <= 8; i++) { 
    for (let v = 0; v <= 9; v++) { //v=10 for training
      trials.push({
        stimulus: `./Subitizing/${i}_V${v}.png`, //"./" = current dir
        correct_response: `${i}`
      });
    }
  };
  trials = jsPsych.randomization.shuffle(trials);

  const preload = {
    type: jsPsychPreload,
      images: trials.map(t => t.stimulus)
  };
  

  const fullscreen = {
    type: jsPsychFullscreen,
    fullscreen_mode: true,
    message: "L'expérience passera en mode plein écran lorsque tu appuyeras sur le bouton ci-dessous<br><br><br>", //Translation of default value
    button_label: "Continuer" //in English, "Continue" by default
  };

  const participant_info = {
    type: jsPsychSurveyText,
    questions: [
      /*
      {
        prompt: "Quel est le genre de l'enfant?",
        placeholder: "_ _ _ _ _",
        name: "Genre",
        required: true,
      },
      {
        prompt: "Quel est la date de naissance de l'enfant",
        placeholder: "mois/année",
        name: "Age",
        required: true,
      },
      */
      {
        prompt: "Quel est le code participant",
        placeholder: "00",
        name: "Code",
        required: true,
      },
    ],
    button_label: "Continuer pour afficher les consignes",
    on_finish: function(data){
      jsPsych.data.addProperties({
        participant_code: data.response.Code
      });
    }
  };

  const hide_cursor = {
    type: jsPsychCallFunction,
    func: function() {
      if(!document.getElementById('hide-cursor')){
        document.querySelector('head')
          .insertAdjacentHTML(
            'beforeend',
            '<style id="hide-cursor">body { cursor: none !important; }</style>'
          );
      }
    }
  };

  const show_cursor = {
    type: jsPsychCallFunction,
    func: function() {
      const el = document.getElementById('hide-cursor');
      if(el) el.remove();
    }
  };

  const intro_training = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: "<p>Début de l'entraînement."+
      "<br>Tu vas voir apparaître plusieurs fois des grenouilles à l’écran."+
      "<br>Dès que tu sais combien de grenouilles il y a, tu dois dire le nombre à voix haute et appuyer en même temps sur la barre espace."+
      "<br>Tu dois être rapide et correct."+
      "<br><br>Appuie sur une touche pour commencer l'entraînement.</p>",
    choices: "ALL_KEYS"
  };


  const training_block = {
    timeline: [
      {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '<div style="font-size:48px;">*</div>',
        choices: "NO_KEYS",
        trial_duration: FIXATION_DURATION
      },
      {
        type: jsPsychImageKeyboardResponse,
        stimulus: jsPsych.timelineVariable('stimulus'),
        choices: CHILD_KEY,
        data: {stimulus_file: jsPsych.timelineVariable('stimulus')},
        on_finish: function(data){
          last_rt_child = data.rt;
        }
      },
      {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '',
        choices: EXPERIMENTER_KEYS,
        data: {correct_response: jsPsych.timelineVariable('correct_response')},
        on_finish: function(data){
          data.training_rt_child = last_rt_child;
          data.training_rt_experimenter = data.rt;
          data.training_experimenter_response = data.response;
          data.training_expected = data.correct_response;
          data.training_correct_response = jsPsych.pluginAPI.compareKeys(data.response, data.correct_response);
        }
      }
    ],
    timeline_variables: training_trials,
    randomize_order: true
  };

  const outro_training = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: "<p>Fin de l'entraînement.<br><br>Appuie sur une touche pour commencer la vraie expérience.</p>",
    choices: "ALL_KEYS"
  };

  function make_subitizing_trials(trials) {
    return {
      timeline: [
        {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: '<div style="font-size:48px;">*</div>',
          choices: "NO_KEYS",
          trial_duration: FIXATION_DURATION
        },
//white screen if wanted:
/*
        {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: '',
          choices: "NO_KEYS",
          trial_duration: WHITE_SCREEN_DURATION
        },
*/
        {
          type: jsPsychImageKeyboardResponse,
          stimulus: jsPsych.timelineVariable('stimulus'),
          choices: CHILD_KEY,
          data: {stimulus_file: jsPsych.timelineVariable('stimulus')},
          on_finish: function(data){
            last_rt_child = data.rt; //just want one easy-to-compute line in the experimenter trial
          }
        },
        {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: '',
          choices: EXPERIMENTER_KEYS, 
          data: {
            correct_response: jsPsych.timelineVariable('correct_response')
          },
          on_finish: function(data){
            data.rt_child = last_rt_child;
            data.rt_experimenter = data.rt;
            data.experimenter_response = data.response;
            data.expected = data.correct_response
            data.correct_response = jsPsych.pluginAPI.compareKeys(data.response, data.correct_response);
          }
        }
      ],
      timeline_variables: trials,
      //randomize_order: true //prerandomize now
    }
  };

  const break_screen = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: "<p>Pause !<br>Appuie sur une touche numérique pour continuer.</p>",
    choices: BREAK_KEYS
  };

  let half = Math.floor(trials.length / 2);
  let trials_block1 = trials.slice(0, half);
  let trials_block2 = trials.slice(half); 

  const exit_fullscreen = {
    type: jsPsychFullscreen,
    fullscreen_mode: false
  };

  
  jsPsych.run([preload, fullscreen, participant_info, hide_cursor, 
  intro_training, training_block, outro_training,
  make_subitizing_trials(trials_block1), break_screen,
  make_subitizing_trials(trials_block2), show_cursor, exit_fullscreen]);
</script>
</html>